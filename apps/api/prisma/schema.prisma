// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  CLIENT
  PROFESSIONAL
  EMPLOYEE
  ADMIN
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  REJECTED
  CANCELLED
  COMPLETED
  NO_SHOW
}

model User {
  id       String   @id @default(cuid())
  email    String?  @unique
  phone    String?  @unique
  password String
  role     UserRole @default(CLIENT)
  isActive Boolean  @default(true)

  // Owner of salons (role PROFESSIONAL)
  ownedSalons Salon[] @relation("SalonOwner")

  // Employee profile (role EMPLOYEE)
  employeeProfile Employee?

  // Client appointments
  appointments Appointment[] @relation("AppointmentClient")

  clientProfile  ClientProfile?
  paymentMethods PaymentMethod[]
  loyaltyAccount LoyaltyAccount?
  paymentIntents PaymentIntent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([role])
  @@index([isActive])
}

model Salon {
  id          String  @id @default(cuid())
  name        String
  description String?
  address     String?
  city        String?
  country     String?
  phone       String?
  isActive    Boolean @default(true)

  ownerId String
  owner   User   @relation("SalonOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  employees      Employee[]
  services       Service[]
  appointments   Appointment[]
  paymentIntents PaymentIntent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerId])
  @@index([isActive])
}

model Employee {
  id String @id @default(cuid())

  salonId String
  salon   Salon  @relation(fields: [salonId], references: [id], onDelete: Cascade)

  // attach a User account for employee login
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  displayName String
  isActive    Boolean @default(true)

  appointments Appointment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([salonId])
  @@index([isActive])
}

model Service {
  id String @id @default(cuid())

  salonId String
  salon   Salon  @relation(fields: [salonId], references: [id], onDelete: Cascade)

  name        String
  description String?
  price       Int // recommend: smallest unit (e.g., cents)
  durationMin Int
  isActive    Boolean @default(true)

  appointments Appointment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([salonId, name])
  @@index([salonId])
  @@index([isActive])
}

model Appointment {
  id     String            @id @default(cuid())
  status AppointmentStatus @default(PENDING)

  salonId String
  salon   Salon  @relation(fields: [salonId], references: [id], onDelete: Cascade)

  clientId String
  client   User   @relation("AppointmentClient", fields: [clientId], references: [id], onDelete: Cascade)

  serviceId String
  service   Service @relation(fields: [serviceId], references: [id], onDelete: Restrict)

  paymentIntents PaymentIntent[]

  employeeId String?
  employee   Employee? @relation(fields: [employeeId], references: [id], onDelete: SetNull)

  startAt DateTime
  endAt   DateTime

  note String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([salonId, startAt])
  @@index([clientId, startAt])
  @@index([employeeId, startAt])
  @@index([status])
}

model Country {
  code     String  @id // "GA", "CD"...
  name     String
  currency String // "FCFA", "$"...
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
}

model ClientProfile {
  id String @id @default(cuid())

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Profil “général” (step 1)
  nickname String
  gender   String
  ageRange String
  city     String
  country  String

  // Step 8
  allergies String? // "yes" | "no"
  comments  String?

  // ✅ Tout le questionnaire multi-steps (hair/nails/face/body/fitness/practical)
  questionnaire Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([city])
  @@index([country])
}

enum PaymentType {
  MOMO
  CARD
  CASH
}

enum LoyaltyTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

enum LoyaltyReason {
  WELCOME
  BOOKING
  REVIEW
  REFERRAL
  ADJUSTMENT
}

model PaymentMethod {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type         PaymentType
  provider     String? // MTN, Visa, Orange...
  providerRef  String? // ID technique PSP
  providerData Json?
  label        String?
  phone        String?
  last4        String?
  isDefault    Boolean     @default(false)
  isActive     Boolean     @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([userId, isDefault])
}

model LoyaltyAccount {
  id String @id @default(cuid())

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  tier           LoyaltyTier @default(BRONZE)
  currentPoints  Int         @default(0)
  lifetimePoints Int         @default(0)

  transactions LoyaltyTransaction[]

  pendingDiscountAmount Int      @default(0) // réduction fixe en attente
  pendingDiscountTier   LoyaltyTier?
  pendingDiscountIssuedAt DateTime?
  pendingDiscountConsumedAt DateTime?
  pendingDiscountConsumedIntentId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LoyaltyTransaction {
  id String @id @default(cuid())

  loyaltyAccountId String
  loyaltyAccount   LoyaltyAccount @relation(fields: [loyaltyAccountId], references: [id], onDelete: Cascade)

  deltaPoints Int
  reason      LoyaltyReason
  meta        Json?
  createdAt   DateTime      @default(now())

  @@index([loyaltyAccountId, createdAt])
}

enum PaymentStatus {
  CREATED
  PENDING
  SUCCEEDED
  FAILED
  CANCELLED
  REFUNDED
}

model PaymentIntent {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  salonId String?
  salon   Salon?  @relation(fields: [salonId], references: [id], onDelete: SetNull)

  appointmentId String?
  appointment   Appointment? @relation(fields: [appointmentId], references: [id], onDelete: SetNull)

  // Money
  amount   Int
  discountAmount Int @default(0)
  payableAmount  Int @default(0)
  appliedDiscountTier LoyaltyTier?
  currency String // "XAF", "USD" ...

  status PaymentStatus @default(CREATED)

  // Provider info
  provider     String? // ex: "MTN", "ORANGE", "STRIPE"
  providerRef  String? // id technique du PSP (transaction/payment intent id)
  providerData Json? // payload utile (channel momo, etc.)

  // Commission ready (même si pas prélevée en bêta)
  platformFeeAmount Int @default(0)
  providerFeeAmount Int @default(0)
  netAmount         Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, createdAt])
  @@index([salonId, createdAt])
  @@index([appointmentId])
  @@index([status])
}
